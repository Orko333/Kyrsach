.story-tree {
  position: relative;
  width: 100%;
  min-height: 600px;
  background: rgba(15, 23, 42, 0.4);
  border-radius: 20px;
  border: 1px solid rgba(99, 102, 241, 0.2);
  /* allow overflowing tree content so wide/deep trees won't be clipped */
  overflow: visible;
  margin: 2rem 0;
  padding: 0.5rem 1rem; /* small inner padding to give breathing room */
}

/* View mode bar */
.view-mode-bar {
  position: sticky;
  top: 0;
  z-index: 5;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: .75rem 1rem;
  background: linear-gradient(135deg, rgba(15,23,42,.95), rgba(30,41,59,.85));
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(99,102,241,.25);
}

.view-mode-buttons {
  display: flex;
  gap: .5rem;
}

.view-mode-buttons button {
  background: rgba(99,102,241,.15);
  color: var(--light);
  border: 1px solid rgba(99,102,241,.35);
  padding: .5rem 1.2rem;
  font-size: .85rem;
  border-radius: 10px;
  cursor: pointer;
  transition: all .25s;
  font-weight: 600;
}

.view-mode-buttons button.active {
  background: var(--gradient);
  color: #fff;
  box-shadow: 0 0 0 2px rgba(99,102,241,.4), 0 4px 12px rgba(99,102,241,.3);
  border-color: var(--primary);
  transform: translateY(-1px);
}

.view-mode-buttons button:hover:not(.active) {
  background: rgba(99,102,241,.3);
  color: #fff;
  transform: translateY(-1px);
}

.tree-controls {
  display: flex;
  gap: .5rem;
}

.tree-controls button {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  border: 1px solid rgba(99,102,241,.4);
  background: rgba(15,23,42,.9);
  color: var(--white);
  font-size: 1rem;
  cursor: pointer;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tree-controls button:hover {
  border-color: var(--primary);
  background: rgba(99,102,241,.25);
  transform: scale(1.05);
}

/* SVG Tree Container */
.tree-svg-container {
  position: relative;
  width: 100%;
  height: 600px;
  /* show overflow so nodes shifted left/right are visible; container padding adds room */
  overflow: visible;
  padding: 2rem 4rem; /* give extra horizontal room for expanded trees */
  user-select: none;
}

.tree-svg-container svg {
  display: block;
  overflow: visible;
  /* allow the svg to expand beyond its box when nodes are shifted */
}

/* List (compact) mode */
.story-tree-list-wrapper {
  max-height: 70vh;
  overflow-y: auto;
  padding: .75rem 1rem 1rem;
}

.story-tree-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: .5rem;
  font-size: .85rem;
}

.list-node {
  background: rgba(30,41,59,.75);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(99,102,241,.25);
  border-radius: 12px;
  padding: .6rem .75rem;
  position: relative;
  transition: border-color .25s, background .25s, box-shadow .25s, transform .2s;
}

.list-node:hover {
  border-color: rgba(99,102,241,.5);
  transform: translateX(3px);
}

.list-node.in-path { 
  border-color: var(--primary);
  background: rgba(99,102,241,.1);
}

.list-node.current { 
  border-color: var(--secondary); 
  box-shadow: 0 0 0 2px rgba(139,92,246,.4), 0 4px 16px rgba(139,92,246,.2);
  background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(168,85,247,.1));
}

.list-node-header {
  display: flex;
  align-items: flex-start;
  gap: .75rem;
  cursor: pointer;
  user-select: none;
}

.list-node-expander {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  border: 1px solid rgba(99,102,241,.35);
  background: rgba(99,102,241,.15);
  color: var(--light);
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  padding: 0;
  transition: all .2s;
  flex-shrink: 0;
}

.list-node-expander:hover { 
  background: rgba(99,102,241,.3); 
  color:#fff;
  transform: scale(1.1);
}

.list-node-thumb {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid rgba(99,102,241,.4);
  flex-shrink: 0;
  transition: transform .2s;
}

.list-node:hover .list-node-thumb {
  transform: scale(1.05);
}

.list-node-main { 
  flex: 1; 
  min-width: 0; 
}

.list-node-line { 
  display: flex; 
  align-items: center; 
  gap: .6rem;
  margin-bottom: .3rem;
}

.badge.index {
  background: var(--gradient);
  color: #fff;
  font-weight: 800;
  font-size: .75rem;
  padding: .4rem .6rem;
  border-radius: 8px;
  letter-spacing: .5px;
  box-shadow: 0 2px 8px rgba(99,102,241,.3);
}

.choice-text {
  color: var(--light);
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  font-size: .85rem;
}

.list-node-meta {
  margin-top: .25rem;
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .5px;
  color: var(--primary);
  font-weight: 700;
}

.list-children {
  list-style: none;
  margin: .5rem 0 0;
  padding: 0 0 0 1.25rem;
  border-left: 2px dashed rgba(99,102,241,.3);
  display: flex;
  flex-direction: column;
  gap: .5rem;
}

.story-tree-empty {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  color: var(--gray);
  font-size: 1.1rem;
  text-align: center;
  padding: 2rem;
}

/* Scrollbar styling (WebKit) */
.story-tree-list-wrapper::-webkit-scrollbar { width: 10px; }
.story-tree-list-wrapper::-webkit-scrollbar-track { background: rgba(15,23,42,.4); border-radius: 5px; }
.story-tree-list-wrapper::-webkit-scrollbar-thumb { background: rgba(99,102,241,.35); border-radius: 5px; }
.story-tree-list-wrapper::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,.6); }

/* Responsive */
@media (max-width: 768px) {
  .story-tree {
    min-height: 400px;
  }
  
  .tree-svg-container {
    height: 400px;
  }
  
  .view-mode-bar {
    flex-direction: column;
    gap: .5rem;
    align-items: stretch;
  }
  
  .tree-controls {
    justify-content: center;
  }
  
  .list-node-thumb {
    width: 48px;
    height: 48px;
  }
}
